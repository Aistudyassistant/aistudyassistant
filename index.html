<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Study Assistant</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Audiowide&family=Poppins:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --neon-blue: #00f2ff;
      --neon-purple: #9f55ff;
      --dark-bg: #0d1117;
      --dark-purple: #302b63;
      --darker-purple: #0f0c29;
    }

    /* Base Body Styles */
    body {
      margin: 0;
      padding: 20px;
      font-family: 'Poppins', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: linear-gradient(135deg, var(--darker-purple), var(--dark-bg));
      color: white;
      box-sizing: border-box;
      overflow-x: hidden; /* Prevent horizontal scroll */
    }

    /* --- Header & Auth Button --- */
    .site-header {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 100;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #userGreeting {
        display: none;
        align-self: center;
        margin-right: 15px;
        color: var(--neon-blue);
        text-shadow: 0 0 5px rgba(0, 242, 255, 0.7);
    }

    #showLoginBtn, #showSignupBtn, #logoutBtn {
      padding: 10px 20px;
      border: 1px solid var(--neon-blue);
      background: rgba(13, 17, 23, 0.5);
      backdrop-filter: blur(5px);
      color: var(--neon-blue);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      font-family: 'Poppins', sans-serif;
      font-weight: 500;
      font-size: 0.9rem;
      text-shadow: 0 0 5px rgba(0, 242, 255, 0.7);
    }
    
    #logoutBtn {
        display: none; /* Hidden by default */
    }

    #showLoginBtn:hover, #showSignupBtn:hover, #logoutBtn:hover {
      background: var(--neon-blue);
      color: var(--dark-bg);
      box-shadow: 0 0 20px var(--neon-blue);
      text-shadow: none;
    }

    /* --- Authentication Modal --- */
    #auth-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(13, 17, 23, 0.6);
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s ease-out;
    }

    #auth-modal.visible {
      opacity: 1;
      pointer-events: auto;
    }

    .form-container {
      perspective: 1000px;
      width: 90%;
      max-width: 400px;
      height: 520px; /* Increased height for error messages */
      position: relative;
    }

    .flipper {
      width: 100%;
      height: 100%;
      position: relative;
      transform-style: preserve-3d;
      transition: transform 0.8s cubic-bezier(0.77, 0, 0.175, 1);
    }
    
    .form-container.flipped .flipper {
      transform: rotateY(180deg);
    }

    .form-face {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      display: flex;
      flex-direction: column;
      justify-content: center;
      padding: 30px;
      box-sizing: border-box;
      background: rgba(13, 17, 23, 0.7);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      border: 1px solid var(--neon-blue);
      box-shadow: 0 0 25px rgba(0, 242, 255, 0.3), 0 0 40px rgba(159, 85, 255, 0.2);
    }

    .login-form { transform: rotateY(0deg); }
    .signup-form { transform: rotateY(180deg); }

    .form-face h2 {
      font-family: 'Audiowide', sans-serif;
      font-size: 2.5rem;
      text-align: center;
      margin: 0 0 30px 0;
      background: linear-gradient(90deg, var(--neon-purple), var(--neon-blue));
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: gradient-pan 8s linear infinite;
      background-size: 200% auto;
    }

    .input-group { margin-bottom: 20px; position: relative; }
    .input-group input {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #555;
      border-radius: 10px;
      outline: none;
      background: rgba(0,0,0,0.3);
      color: white;
      font-family: 'Poppins', sans-serif;
      font-size: 1rem;
      transition: border-color 0.3s, box-shadow 0.3s;
      box-sizing: border-box;
    }
    .input-group input:focus { border-color: var(--neon-blue); box-shadow: 0 0 10px rgba(0, 242, 255, 0.5); }
    .input-group input::placeholder { color: #888; }
    
    .error-message {
      color: #ff5555;
      text-align: center;
      font-size: 0.9rem;
      margin-top: -10px;
      margin-bottom: 15px;
      height: 1em; /* Reserve space to prevent layout shift */
    }

    .form-btn {
      width: 100%;
      padding: 12px 20px;
      margin-top: 10px;
      border: 1px solid var(--neon-blue);
      background: transparent;
      color: var(--neon-blue);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      font-family: 'Poppins', sans-serif;
      font-weight: 500;
      font-size: 1rem;
      text-shadow: 0 0 5px rgba(0, 242, 255, 0.7);
    }
    .form-btn:hover { background: var(--neon-blue); color: var(--dark-bg); box-shadow: 0 0 20px var(--neon-blue); text-shadow: none; }
    .form-btn:disabled {
        cursor: not-allowed;
        opacity: 0.6;
    }

    .toggle-link { text-align: center; margin-top: 20px; color: #ccc; }
    .toggle-link a { color: var(--neon-blue); text-decoration: none; font-weight: 500; cursor: pointer; transition: text-shadow 0.3s; }
    .toggle-link a:hover { text-shadow: 0 0 8px rgba(0, 242, 255, 0.8); }

    /* --- Main App Section --- */
    .intro {
      text-align: center;
      margin-bottom: 15vh;
      animation: fadeIn 2s ease-in-out;
      width: 90%;
    }

    .intro h1 {
      font-family: 'Audiowide', sans-serif;
      font-size: clamp(3rem, 10vw, 5.5rem);
      font-weight: 400;
      margin: 0;
      letter-spacing: 2px;
      background: linear-gradient(90deg, var(--neon-purple), var(--neon-blue), #55ffb8, var(--neon-purple));
      background-size: 250% auto;
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: gradient-pan 8s linear infinite;
    }

    .intro h2 {
      font-size: clamp(1rem, 4vw, 1.5rem);
      font-weight: 400;
      margin-top: 10px;
      color: #ccc;
      text-shadow: 0 0 10px rgba(0, 242, 255, 0.3);
    }

    /* --- Chat Container --- */
    .chat-container {
      width: 90%;
      max-width: 700px;
      background: rgba(13, 17, 23, 0.7);
      backdrop-filter: blur(5px);
      border-radius: 20px;
      border: 1px solid var(--neon-blue);
      box-shadow: 0 0 25px rgba(0, 242, 255, 0.4);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      animation: slideUpFadeIn 0.7s ease-out 1s forwards;
      transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
      z-index: 200;
    }

    .chat-header {
      display: none; /* Hidden on desktop */
      padding: 10px 15px;
      text-align: center;
      position: relative;
      border-bottom: 1px solid var(--neon-blue);
    }
    .chat-header h3 {
        margin: 0;
        font-weight: 500;
        color: var(--neon-blue);
    }
    #closeChatBtn {
        position: absolute;
        top: 50%;
        right: 15px;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: white;
        font-size: 2rem;
        cursor: pointer;
        line-height: 1;
    }

    .chat-box {
      padding: 0 15px;
      overflow-y: auto;
      font-size: 0.95rem;
      display: flex;
      flex-direction: column;
      gap: 10px;
      flex-grow: 1;
      max-height: 50vh; 
      transition: all 0.3s ease-in-out;
    }
    
    .chat-box::-webkit-scrollbar { width: 5px; }
    .chat-box::-webkit-scrollbar-track { background: transparent; }
    .chat-box::-webkit-scrollbar-thumb { background: var(--neon-blue); border-radius: 10px; }

    .chat-container.chat-active .chat-box { padding: 15px; }
    .chat-container.is-collapsed .chat-box { max-height: 0; padding-top: 0; padding-bottom: 0; overflow: hidden; }

    .message { padding: 10px 15px; border-radius: 15px; max-width: 80%; word-wrap: break-word; width: fit-content; }
    .user-message { background: #333; color: #eee; align-self: flex-end; margin-left: auto; border: 1px solid #444; }
    .bot-message { background: var(--dark-purple); color: white; align-self: flex-start; border: 1px solid var(--neon-blue); }

    .chat-input { display: flex; padding: 12px; background: rgba(0,0,0,0.2); align-items: center; border-top: 1px solid transparent; transition: border-top-color 0.3s ease; }
    .chat-container.chat-active:not(.is-collapsed) .chat-input { border-top-color: var(--neon-blue); }
    .chat-input input[type="text"] { flex: 1; padding: 10px; border: 1px solid #555; border-radius: 10px; outline: none; margin-right: 10px; background: #222; color: white; font-family: 'Poppins', sans-serif; transition: border-color 0.3s, box-shadow 0.3s; }
    .chat-input input:focus { border-color: var(--neon-blue); box-shadow: 0 0 10px rgba(0, 242, 255, 0.5); }
    .chat-input input::placeholder { color: #888; }
    .chat-input label { margin-right: 10px; cursor: pointer; font-size: 18px; color: #888; transition: color 0.3s, text-shadow 0.3s; }
    .chat-input label:hover { color: var(--neon-blue); text-shadow: 0 0 8px rgba(0, 242, 255, 0.8); }

    #voiceBtn {
      padding: 10px;
      border: none;
      background: transparent;
      color: #888;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 1.2rem;
      margin-right: 5px;
    }
    #voiceBtn:hover { color: var(--neon-blue); text-shadow: 0 0 8px rgba(0, 242, 255, 0.7); }
    #voiceBtn.is-listening { color: var(--neon-blue); animation: pulse 1.5s infinite; }

    .chat-input button { padding: 10px 16px; border: 1px solid var(--neon-blue); background: transparent; color: var(--neon-blue); border-radius: 8px; cursor: pointer; transition: all 0.3s; font-family: 'Poppins', sans-serif; font-weight: 500; text-shadow: 0 0 5px rgba(0, 242, 255, 0.7); }
    .chat-input button:hover { background: var(--neon-blue); color: var(--dark-bg); box-shadow: 0 0 20px var(--neon-blue); text-shadow: none; }

    /* Keyframe Animations */
    @keyframes gradient-pan { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    @keyframes fadeIn { from {opacity: 0; transform: translateY(20px);} to {opacity: 1; transform: translateY(0);} }
    @keyframes slideUpFadeIn { from { opacity: 0; transform: translate(-50%, 20px); } to { opacity: 1; transform: translate(-50%, 0); } }
    @keyframes pulse {
      0% { transform: scale(1); text-shadow: 0 0 5px rgba(0, 242, 255, 0.7); }
      50% { transform: scale(1.1); text-shadow: 0 0 15px rgba(0, 242, 255, 1); }
      100% { transform: scale(1); text-shadow: 0 0 5px rgba(0, 242, 255, 0.7); }
    }

    /* --- Mobile Responsive Styles --- */
    @media (max-width: 768px) {
        .site-header {
            padding: 10px;
            top: 0;
            right: 0;
            left: 0;
            justify-content: flex-end;
        }

        .chat-container.mobile-fullscreen {
            width: 100%;
            height: 100%;
            bottom: 0;
            left: 0;
            top: 0;
            border-radius: 0;
            transform: none;
        }

        .chat-container.mobile-fullscreen .chat-header {
            display: block;
        }

        .chat-container.mobile-fullscreen .chat-box {
            max-height: none;
        }
    }

  </style>
</head>
<body>

  <header class="site-header">
    <span id="userGreeting"></span>
    <button id="showLoginBtn">Login</button>
    <button id="showSignupBtn">Sign Up</button>
    <button id="logoutBtn">Logout</button>
  </header>
  
  <!-- Authentication Modal -->
  <div id="auth-modal">
    <div class="form-container" id="formContainer">
      <div class="flipper">
        <div class="form-face login-form">
          <h2>Login</h2>
          <form id="loginForm">
            <div class="input-group"><input type="email" placeholder="Email" required name="email"></div>
            <div class="input-group"><input type="password" placeholder="Password" required name="password"></div>
            <p class="error-message" id="loginError"></p>
            <button type="submit" class="form-btn">Login</button>
            <p class="toggle-link">No account? <a id="showSignup">Sign Up</a></p>
          </form>
        </div>
        <div class="form-face signup-form">
          <h2>Sign Up</h2>
          <form id="signupForm">
            <div class="input-group"><input type="text" placeholder="Username" required name="username"></div>
            <div class="input-group"><input type="email" placeholder="Email" required name="email"></div>
            <div class="input-group"><input type="password" placeholder="Password" required name="password"></div>
            <p class="error-message" id="signupError"></p>
            <button type="submit" class="form-btn">Sign Up</button>
            <p class="toggle-link">Already have an account? <a id="showLogin">Login</a></p>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Main App Content -->
  <div class="intro">
    <h1 id="mainGreeting">Hi, I'm Umer</h1>
    <h2 id="mainSubtitle">Your AI Study Assistant<br>How can I help you today?</h2>
  </div>
  <div class="chat-container">
    <div class="chat-header">
        <h3>AI Assistant</h3>
        <button id="closeChatBtn">&times;</button>
    </div>
    <div class="chat-box" id="chatBox"></div>
    <div class="chat-input">
      <input type="text" id="userInput" placeholder="Type your question here...">
      <label for="fileUpload">📎</label>
      <input type="file" id="fileUpload" style="display:none;">
      <button id="voiceBtn" title="Use Voice">🎤</button>
      <button onclick="sendMessage()" id="sendBtn">Send</button>
    </div>
  </div>

<!-- Firebase SDK -->
<script type="module">
  // Your web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyBnE7ZDKMlBi4WmbRS4U1HyQ9A8YEsmbKQ",
    authDomain: "data-base-of-study-assitant.firebaseapp.com",
    projectId: "data-base-of-study-assitant",
    storageBucket: "data-base-of-study-assitant.appspot.com",
    messagingSenderId: "614569134909",
    appId: "1:614569134909:web:553a92a01a37724edd9354",
    measurementId: "G-WVJSQWC6BG"
  };

  // Import Firebase modules
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-analytics.js";
  import { 
    getAuth, 
    createUserWithEmailAndPassword, 
    signInWithEmailAndPassword, 
    onAuthStateChanged, 
    signOut 
  } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
  import { 
    getFirestore, 
    collection, 
    addDoc, 
    query, 
    orderBy, 
    onSnapshot,
    serverTimestamp,
    doc,
    setDoc,
    getDoc,
    enableIndexedDbPersistence // Import offline persistence
  } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // --- Enable Offline Persistence ---
  enableIndexedDbPersistence(db)
    .catch((err) => {
        if (err.code == 'failed-precondition') {
            console.warn("Firestore persistence failed, likely due to multiple tabs open.");
        } else if (err.code == 'unimplemented') {
            console.warn("Firestore persistence is not available in this browser.");
        }
    });

  // --- Global State ---
  let currentUserId = null;
  let unsubscribeMessages = null; 

  // --- Element Selectors ---
  const authModal = document.getElementById('auth-modal');
  const showLoginBtn = document.getElementById('showLoginBtn');
  const showSignupBtn = document.getElementById('showSignupBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const userGreeting = document.getElementById('userGreeting');
  const mainGreeting = document.getElementById('mainGreeting');
  const mainSubtitle = document.getElementById('mainSubtitle');
  const formContainer = document.getElementById('formContainer');
  const showSignupLink = document.getElementById('showSignup');
  const showLoginLink = document.getElementById('showLogin');
  const loginForm = document.getElementById('loginForm');
  const signupForm = document.getElementById('signupForm');
  const loginError = document.getElementById('loginError');
  const signupError = document.getElementById('signupError');
  const userInput = document.getElementById("userInput");
  const chatBox = document.getElementById("chatBox");
  const chatContainer = document.querySelector(".chat-container");
  const closeChatBtn = document.getElementById('closeChatBtn');
  const fileUpload = document.getElementById("fileUpload");
  const voiceBtn = document.getElementById('voiceBtn');
  const sendBtn = document.getElementById('sendBtn');

  // --- UI Update Functions ---
  async function updateUiForAuthState(user, username = null) {
    // Reset potential error state first
    mainSubtitle.style.color = '#ccc';
    mainSubtitle.innerHTML = 'Your AI Study Assistant<br>How can I help you today?';
    
    if (user) {
      currentUserId = user.uid;
      let displayName = username;
      let profileError = false;

      if (!displayName) {
          try {
            const userDocRef = doc(db, 'users', user.uid);
            const userDocSnap = await getDoc(userDocRef);
            if (userDocSnap.exists()) {
                displayName = userDocSnap.data().username;
            } else {
                displayName = "there"; 
                console.warn("User document not found for uid:", user.uid);
            }
          } catch (error) {
            console.error("CRITICAL: Could not fetch user profile.", error);
            profileError = true;
            displayName = "there";
          }
      }

      userGreeting.textContent = `Hi, ${displayName} 👋`;
      mainGreeting.textContent = "Hi, I'm Umer"; // <-- This is now static
      userGreeting.style.display = 'inline';
      showLoginBtn.style.display = 'none';
      showSignupBtn.style.display = 'none';
      logoutBtn.style.display = 'block';
      authModal.classList.remove('visible');
      userInput.placeholder = "Type your question here...";
      sendBtn.disabled = false;
      loadMessages(currentUserId);

      if(profileError) {
          mainSubtitle.innerHTML = "Your profile could not be loaded. <br> Please update your Firebase Security Rules.";
          mainSubtitle.style.color = "#ff9494";
      }

    } else {
      currentUserId = null;
      userGreeting.style.display = 'none';
      mainGreeting.textContent = "Hi, I'm Umer";
      showLoginBtn.style.display = 'block';
      showSignupBtn.style.display = 'block';
      logoutBtn.style.display = 'none';
      chatBox.innerHTML = '<div class="message bot-message">Please log in to see your chat history.</div>';
      userInput.placeholder = "Please log in to chat...";
      sendBtn.disabled = true;
      if (unsubscribeMessages) {
        unsubscribeMessages();
      }
    }
  }

  // --- Firebase Auth State Listener ---
  onAuthStateChanged(auth, (user) => {
    updateUiForAuthState(user);
  });
  
  // --- Authentication Modal Logic ---
  showLoginBtn.addEventListener('click', () => {
    loginError.textContent = '';
    signupError.textContent = '';
    if (formContainer.classList.contains('flipped')) {
      formContainer.classList.remove('flipped');
    }
    authModal.classList.add('visible');
  });

  showSignupBtn.addEventListener('click', () => {
    loginError.textContent = '';
    signupError.textContent = '';
    if (!formContainer.classList.contains('flipped')) {
      formContainer.classList.add('flipped');
    }
    authModal.classList.add('visible');
  });
  
  logoutBtn.addEventListener('click', async () => {
    try {
        await signOut(auth);
    } catch (error) {
        console.error("Error signing out: ", error);
    }
  });

  authModal.addEventListener('click', (e) => { if (e.target === authModal) authModal.classList.remove('visible'); });
  showSignupLink.addEventListener('click', (e) => { e.preventDefault(); formContainer.classList.add('flipped'); });
  showLoginLink.addEventListener('click', (e) => { e.preventDefault(); formContainer.classList.remove('flipped'); });

  // --- Auth Form Submissions ---
  signupForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const submitBtn = signupForm.querySelector('.form-btn');
    const originalBtnText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = 'Signing Up...';

    const username = signupForm.username.value;
    const email = signupForm.email.value;
    const password = signupForm.password.value;
    signupError.textContent = '';
    try {
      const userCredential = await createUserWithEmailAndPassword(auth, email, password);
      const user = userCredential.user;
      await setDoc(doc(db, "users", user.uid), {
          username: username,
          email: email
      });
      // Pass the username directly to avoid a refetch
      updateUiForAuthState(user, username);
    } catch (error) {
      signupError.textContent = error.message;
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = originalBtnText;
    }
  });

  loginForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const submitBtn = loginForm.querySelector('.form-btn');
    const originalBtnText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = 'Logging In...';

    const email = loginForm.email.value;
    const password = loginForm.password.value;
    loginError.textContent = '';
    try {
      const userCredential = await signInWithEmailAndPassword(auth, email, password);
      updateUiForAuthState(userCredential.user);
    } catch (error) {
      loginError.textContent = error.message;
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = originalBtnText;
    }
  });

  // --- Firestore & Chat Logic ---
  function loadMessages(uid) {
    if (unsubscribeMessages) {
        unsubscribeMessages(); 
    }
    
    if (!auth.currentUser || auth.currentUser.uid !== uid) {
        return;
    }

    const messagesRef = collection(db, 'chats', uid, 'messages');
    const q = query(messagesRef, orderBy('timestamp'));

    unsubscribeMessages = onSnapshot(q, (snapshot) => {
      chatBox.innerHTML = '';
      if (snapshot.empty) {
         chatBox.innerHTML = '<div class="message bot-message">Ask me anything to start the conversation!</div>';
      } else {
        snapshot.forEach(doc => {
            const msg = doc.data();
            appendMessage(msg.text, msg.sender);
        });
      }
      chatBox.scrollTop = chatBox.scrollHeight;
    }, (error) => {
        console.error("Error loading messages:", error);
        if (error.code === 'permission-denied') {
             chatBox.innerHTML = '<div class="message bot-message">Error: You do not have permission to view these messages. Please check security rules in your Firebase project.</div>';
        } else {
             chatBox.innerHTML = '<div class="message bot-message">Could not load chat history. Check your connection.</div>';
        }
    });
  }

  window.sendMessage = async function() {
    if (!currentUserId) {
        appendMessage("Please log in to send a message.", "bot");
        return;
    }

    const messageText = userInput.value.trim();
    const selectedFile = fileUpload.files[0];

    if (messageText === "" && !selectedFile) return;
    
    const tempMessage = messageText || selectedFile.name;
    userInput.value = "";
    fileUpload.value = ""; 

    const userMessage = {
        text: tempMessage,
        sender: 'user',
        timestamp: serverTimestamp()
    };
    const messagesRef = collection(db, 'chats', currentUserId, 'messages');
    try {
        await addDoc(messagesRef, userMessage);
    } catch (error) {
        console.error("Error saving user message:", error);
        userInput.value = tempMessage;
        appendMessage("Error: Could not save your message.", "bot");
        return;
    }

    try {
      let res;
      const webhookUrl = "https://umernaveed.app.n8n.cloud/webhook/aistudy";

      if (selectedFile) {
        const formData = new FormData();
        formData.append("file", selectedFile);
        formData.append("text", messageText);
        formData.append("userId", currentUserId);
        res = await fetch(webhookUrl, { method: "POST", body: formData });
      } else {
         res = await fetch(webhookUrl, { 
            method: "POST", 
            headers: { "Content-Type": "application/json" }, 
            body: JSON.stringify({ question: tempMessage, userId: currentUserId })
        });
      }
      
      if (!res.ok) throw new Error(`Server responded with status: ${res.status}`);
      const data = await res.json();
      const botReply = data.answer || "Sorry, I couldn't get a response.";
      
      const botMessage = { text: botReply, sender: 'bot', timestamp: serverTimestamp() };
      await addDoc(messagesRef, botMessage);

    } catch (err) {
      console.error("Error connecting to webhook:", err);
      const errorMessage = { text: "Error: Could not connect to the AI assistant.", sender: 'bot', timestamp: serverTimestamp() };
      await addDoc(messagesRef, errorMessage);
    }
  }

  function appendMessage(text, sender) {
    const messageElement = document.createElement("div");
    messageElement.className = `message ${sender}-message`;
    messageElement.innerText = text;
    chatBox.appendChild(messageElement);
    chatBox.scrollTop = chatBox.scrollHeight;
  }
  
  // --- Voice Input Logic ---
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (SpeechRecognition) {
    const recognition = new SpeechRecognition();
    recognition.continuous = false;
    recognition.lang = 'en-US';
    recognition.interimResults = true;
    let isListening = false;
    voiceBtn.addEventListener('click', () => {
      if (!currentUserId) { return; }
      isListening ? recognition.stop() : recognition.start();
    });
    recognition.onstart = () => { isListening = true; voiceBtn.classList.add('is-listening'); userInput.placeholder = 'Listening...'; };
    recognition.onend = () => { isListening = false; voiceBtn.classList.remove('is-listening'); userInput.placeholder = 'Type your question here...'; };
    recognition.onresult = (event) => {
      userInput.value = Array.from(event.results).map(r => r[0]).map(r => r.transcript).join('');
    };
    recognition.onerror = (e) => { console.error('Speech recognition error:', e.error); appendMessage(`Speech error: ${e.error}`, 'bot'); };
  } else {
    voiceBtn.style.display = 'none';
  }

  // --- General Event Listeners ---
  userInput.addEventListener("keypress", (e) => { if (e.key === "Enter") { e.preventDefault(); sendMessage(); } });
  
  userInput.addEventListener("focus", () => { 
    chatContainer.classList.add("chat-active");
    if (window.innerWidth <= 768) {
        chatContainer.classList.add('mobile-fullscreen');
    }
    if (chatContainer.classList.contains("is-collapsed")) { 
      chatContainer.classList.remove("is-collapsed"); 
    } 
  });
  
  function closeChat() {
      chatContainer.classList.add("is-collapsed");
      if (window.innerWidth <= 768) {
        chatContainer.classList.remove('mobile-fullscreen');
      }
  }
  
  closeChatBtn.addEventListener('click', closeChat);

  document.addEventListener("click", (e) => {
    const isChatActive = chatContainer.classList.contains("chat-active");
    const isCollapsed = chatContainer.classList.contains("is-collapsed");
    const isClickOutside = !chatContainer.contains(e.target) && !authModal.contains(e.target) && !e.target.closest('.site-header');
    
    if (isChatActive && !isCollapsed && isClickOutside) {
        closeChat();
    }
  });

</script>

</body>
</html>

